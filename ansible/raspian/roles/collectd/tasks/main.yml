- name: collectd packages
  apt: pkg={{item}} install_recommends=no state=present
  with_items:
    - collectd-core
    - librrd4
    - rrdcached

- name: rrdcached config
  # Default for write to disk interval is 300s - see http://oss.oetiker.ch/rrdtool/doc/rrdcached.en.html)
  lineinfile: dest=/etc/default/rrdcached regexp=OPTS= line='OPTS="-l unix:/var/run/rrdcached.sock -w {{rrdcached_disk_write_interval}}"'
  notify: restart rrdcached

- name: copy configuration file
  template: src=collectd.conf.j2 dest=/etc/collectd/collectd.conf
  notify: restart collectd

- name: create collectd plugin directory
  file: path={{ plugin_conf_dir }} state=directory

- name: copy configuration files
  template: src={{ item }}.conf.j2 dest={{ plugin_conf_dir }}/{{ item }}.conf
  with_items: collectd_configs 
  notify: restart collectd

# Collectd Graph Panel - see also https://www.debinux.de/2014/01/systemstatus-mit-collectd-und-collectd-graph-panel/
- name: download Collectd Graph Panel
  get_url: url=https://github.com/pommi/CGP/archive/v0.4.1.zip dest=/root/cgp.zip
- name: unzip CGP
  unarchive: src=/root/cgp.zip dest=/var/www/ copy=no owner=www-data group=www-data
- name: cgp symlink
  file: src=/var/www/CGP-0.4.1 dest=/var/www/cgp state=link
- name: rrdtool
  apt: pkg=rrdtool state=present
